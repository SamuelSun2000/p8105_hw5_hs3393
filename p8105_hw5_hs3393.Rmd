---
title: "p8105_hw5_hs3393"
author: "Haochen Sun"
date: "2022-11-03"
output: github_document
---

```{r pload packages, message=FALSE}
library(tidyverse)
library(ggplot2)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1
```{r}
```

## Problem 2
```{r problem 2}
data <- read_csv("data/homicide-data.csv")
head(data)
```

The data describes `r nrow(data)` criminal homicides. The dataset includes the id, report date of homicides, the victims' race, name, gender, age, as well as the place where the homicide happened, specified to city, state, longtitude and latitude. Also, the data despcribes the result of the homicide (whether it is closed and someone is arrested).

```{r, prob2 data manipulation}
casenum <- data %>% 
  janitor::clean_names() %>% 
  unite("city_state", c(city, state), sep = ", ", remove = F) %>%
  mutate(solve = if_else(
    disposition != "Closed by arrest",
    true = "unsolved", false = "solved"
  )) %>% 
  group_by(city_state, solve) %>% 
  summarise(case = n()) %>% 
  pivot_wider(names_from = solve, values_from = case) %>% 
  mutate(total = solved + unsolved)

Baltimore <- filter(casenum, city_state == "Baltimore, MD")

Baltimore_result <- prop.test(Baltimore[["unsolved"]], Baltimore[["total"]]) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
```

For Baltimore,MD, the estimated proportion of unsolved homicides will be `r round(pull(Baltimore_result, estimate), digits = 4)`, the confidence interval will be `r str_c("(", round(pull(Baltimore_result, conf.low), digits = 4), ",", round(pull(Baltimore_result, conf.high), digits = 4), ")")`.


```{r prop.test for every city}

casenum %>% 
  filter(city_state != "Tulsa, AL") %>% 
  # This is because Tulsa, AL only have 1 sample! Not enough for a proportion test, so just leave it out
  
  mutate(
    prop_test = map2(.x = unsolved, .y = total, ~prop.test(x = .x, n = .y))
    ) %>% 
  mutate(
    prop_test = map(prop_test, broom::tidy)
  ) %>% 
  unnest(prop_test) %>% 
  select(city_state:estimate, conf.low, conf.high) %>%
  ungroup() %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point(size = 1) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 1) +
  coord_flip() +
  labs(y = "Estimate proportion", x = "City", title = "Estimated proportion of unsolved homicides in each city")
```



